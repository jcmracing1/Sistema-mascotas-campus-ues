<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ubicación de Mascotas - Campus Universitario</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Fuente y estilo -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#faf9f7;
      --card:#fff;
      --shadow:0 4px 18px rgba(0,0,0,0.08);
      --radius:16px;
      --accent:#2b7cff;
    }
    body {
      margin:0;
      background:var(--bg);
      font-family:"Nunito",sans-serif;
      color:#222;
    }
    header {
      text-align:center;
      padding:20px;
      font-weight:800;
      font-size:22px;
      letter-spacing:1px;
    }
    .pet-list {
      display:flex;
      gap:14px;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:20px;
    }
    .pet-card {
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      width:150px;
      text-align:center;
      cursor:pointer;
      transition:transform 0.15s ease;
    }
    .pet-card:hover { transform:scale(1.05); }
    .pet-card img {
      width:100%;
      height:120px;
      border-top-left-radius:var(--radius);
      border-top-right-radius:var(--radius);
      object-fit:cover;
    }
    .pet-card h3 {
      margin:6px;
      font-size:15px;
    }
    .container {
      display:grid;
      grid-template-columns: 1fr 1fr 320px;
      grid-gap:18px;
      max-width:1200px;
      margin:0 auto;
      padding:10px;
    }
    .photo-card, .desc-card, .controls, .map-card, .history {
      background:var(--card);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .photo-card img {
      width:100%;
      height:320px;
      object-fit:cover;
      border-radius:10px;
    }
    .map-card { grid-column: 1 / span 2; }
    #map { width:100%; height:430px; border-radius:10px; }
    .history { overflow:auto; height:460px; }
    .entry {
      padding:8px;
      border:1px solid #eee;
      border-radius:8px;
      margin-bottom:6px;
      cursor:pointer;
    }
    .out-alert { color:red; font-weight:bold; }
    #addPetBtn {
      display:block;
      margin:20px auto;
      padding:10px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:bold;
    }
    #addForm {
      display:none;
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      max-width:400px;
      margin:20px auto;
      padding:16px;
    }
    #addForm input, #addForm textarea {
      width:100%;
      margin-bottom:10px;
      padding:8px;
      border-radius:8px;
      border:1px solid #ccc;
      font-family:inherit;
    }
    #addForm button {
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
    }
    @media(max-width:1024px){ .container{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
  <header>SISTEMA DE UBICACIÓN DE MASCOTAS EN EL CAMPUS UNIVERSITARIO</header>

  <section class="pet-list" id="petList"></section>

  <div class="container">
    <div class="photo-card">
      <h2 id="petName">Nombre de Mascota</h2>
      <img id="petPhoto" src="img/lola.jpg" alt="Mascota" />
    </div>

    <div class="desc-card">
      <h3>Descripción</h3>
      <p id="petDesc">Aquí se muestra la información de la mascota seleccionada.</p>
    </div>

    <aside class="controls">
      <h4>Última posición</h4>
      <p>Lat: <span id="lastLat">--</span></p>
      <p>Lng: <span id="lastLng">--</span></p>
      <p>Alt: <span id="lastAlt">--</span> m</p>
      <p>Actualizado: <span id="lastTime">--</span></p>
      <p id="campusStatus"></p>
    </aside>

    <section class="map-card">
      <h3>Ubicación actual</h3>
      <div id="map"></div>
    </section>

    <aside class="history">
      <h3>Historial de ubicaciones</h3>
      <div id="historyList"></div>
    </aside>
  </div>

  <!-- Botón y formulario para agregar mascota -->
  <button id="addPetBtn">➕ Agregar Mascota</button>

  <div id="addForm">
    <h3>Nueva Mascota</h3>
    <input type="text" id="newName" placeholder="Nombre de la mascota" required>
    <textarea id="newDesc" placeholder="Descripción"></textarea>
    <input type="file" id="newPhoto" accept="image/*">
    <button id="savePet">Guardar</button>
  </div>

<script>
const pets = [
  { name:"Nessa", desc:"Perrita pitbull, le gusta correr.", photo:"img/nessa.png", channel:"3146056", api:"GSRK8SFFHTSPZALK" },
  { name:"Cleo", desc:"Perrita bóxer, le gusta pasear cerca de cafetería.", photo:"img/cleo.jpg", channel:"3146056", api:"GSRK8SFFHTSPZALK" },
  { name:"Doguie", desc:"Perra mediana, suele estar en veterinaria. Usa collar GPS azul.", photo:"img/doguie.jpg", channel:"3146056", api:"GSRK8SFFHTSPZALK" }
];

const petList=document.getElementById("petList");
pets.forEach((p,i)=>{
  const el=document.createElement("div");
  el.className="pet-card";
  el.innerHTML=`<img src="${p.photo}" alt="${p.name}"><h3>${p.name}</h3>`;
  el.onclick=()=>loadPet(i);
  petList.appendChild(el);
});

const map=L.map('map').setView([13.718, -89.202], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
let marker=null;
let polyline=L.polyline([], {color:'#ff6b6b',weight:4}).addTo(map);

const campusCoords = [
  [13.7233, -89.2032],[13.7224, -89.1994],[13.7165, -89.2003],
  [13.7152, -89.2060],[13.7190, -89.2075],[13.7220, -89.2050]
];
const campusPolygon = L.polygon(campusCoords, {color:'green', fillOpacity:0.1}).addTo(map);

function isInsidePolygon(lat, lng, polygonCoords) {
  let inside = false;
  for (let i = 0, j = polygonCoords.length - 1; i < polygonCoords.length; j = i++) {
    const xi = polygonCoords[i][1], yi = polygonCoords[i][0];
    const xj = polygonCoords[j][1], yj = polygonCoords[j][0];
    const intersect = ((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

async function loadPet(index){
  const pet=pets[index];
  document.getElementById("petName").textContent=pet.name;
  document.getElementById("petDesc").textContent=pet.desc;
  document.getElementById("petPhoto").src=pet.photo;

  const url=`https://api.thingspeak.com/channels/${pet.channel}/feeds.json?api_key=${pet.api}&results=100`;
  const res=await fetch(url);
  const data=await res.json();
  const feeds=data.feeds;
  if(!feeds||feeds.length===0)return;

  const coords=feeds.filter(f=>f.field1&&f.field2).map(f=>({
    lat:parseFloat(f.field1), lng:parseFloat(f.field2),
    alt:f.field3?parseFloat(f.field3):0, time:f.created_at
  }));

  const last=coords[coords.length-1];
  document.getElementById("lastLat").textContent=last.lat.toFixed(6);
  document.getElementById("lastLng").textContent=last.lng.toFixed(6);
  document.getElementById("lastAlt").textContent=last.alt.toFixed(1);
  document.getElementById("lastTime").textContent=new Date(last.time).toLocaleString();

  if(marker) map.removeLayer(marker);
  marker=L.marker([last.lat,last.lng]).addTo(map)
    .bindPopup(`${pet.name}<br>${new Date(last.time).toLocaleString()}`).openPopup();

  polyline.setLatLngs(coords.map(c=>[c.lat,c.lng]));
  map.fitBounds(polyline.getBounds().pad(0.2));

  const inside=isInsidePolygon(last.lat,last.lng,campusCoords);
  const statusEl=document.getElementById("campusStatus");
  if(inside){
    statusEl.textContent="Dentro del campus";
    statusEl.classList.remove("out-alert");
  }else{
    statusEl.textContent="⚠️ Fuera del campus";
    statusEl.classList.add("out-alert");
  }

  const list=document.getElementById("historyList");
  list.innerHTML='';
  coords.reverse().forEach(c=>{
    const item=document.createElement('div');
    item.className='entry';
    item.textContent=`${new Date(c.time).toLocaleString()} → ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
    item.onclick=()=>map.setView([c.lat,c.lng],18);
    list.appendChild(item);
  });
}

loadPet(0);

/* --- Formulario agregar mascota --- */
const addBtn=document.getElementById("addPetBtn");
const form=document.getElementById("addForm");
const saveBtn=document.getElementById("savePet");

addBtn.onclick=()=> form.style.display = form.style.display==="block" ? "none" : "block";

saveBtn.onclick=()=>{
  const name=document.getElementById("newName").value.trim();
  const desc=document.getElementById("newDesc").value.trim();
  const file=document.getElementById("newPhoto").files[0];
  if(!name){ alert("Ingrese un nombre"); return; }

  if(file){
    const reader=new FileReader();
    reader.onload=()=>{
      const newPet={ name, desc, photo:reader.result, channel:"3146056", api:"GSRK8SFFHTSPZALK" };
      pets.push(newPet);
      const el=document.createElement("div");
      el.className="pet-card";
      el.innerHTML=`<img src="${reader.result}" alt="${name}"><h3>${name}</h3>`;
      el.onclick=()=>loadPet(pets.length-1);
      petList.appendChild(el);
      form.style.display="none";
      document.getElementById("newName").value="";
      document.getElementById("newDesc").value="";
      document.getElementById("newPhoto").value="";
    };
    reader.readAsDataURL(file);
  } else {
    const newPet={ name, desc, photo:"img/default.png", channel:"3146056", api:"GSRK8SFFHTSPZALK" };
    pets.push(newPet);
    const el=document.createElement("div");
    el.className="pet-card";
    el.innerHTML=`<img src="img/default.png" alt="${name}"><h3>${name}</h3>`;
    el.onclick=()=>loadPet(pets.length-1);
    petList.appendChild(el);
    form.style.display="none";
  }
};
</script>
</body>
</html>
